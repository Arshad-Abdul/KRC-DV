<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scopus API Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .test-button {
            display: block;
            width: 200px;
            margin: 20px auto;
            padding: 15px;
            background-color: #007acc;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
        }
        .test-button:hover {
            background-color: #005c99;
        }
        .console-output {
            background-color: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .error { color: #ff6b6b; }
        .success { color: #51cf66; }
        .info { color: #74c0fc; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔬 Scopus API Connection Test</h1>
        <p>This test will help us diagnose the exact error when trying to connect to the Scopus API from your campus network.</p>
        
        <button class="test-button" onclick="runTest()">🚀 Test Scopus API Connection</button>
        
        <div id="output" class="console-output" style="display: none;">
            <div id="console-log"></div>
        </div>
    </div>

    <script>
        const SCOPUS_API_KEY = '45ffcd08728def3545ed81fd42148ba3';
        const SCOPUS_BASE_URL = 'https://api.elsevier.com/content';
        
        // Custom console logger for the UI
        const logger = {
            log: (message, type = 'info') => {
                const output = document.getElementById('console-log');
                const timestamp = new Date().toLocaleTimeString();
                const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
                output.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
                output.scrollTop = output.scrollHeight;
            },
            error: (message) => logger.log(message, 'error'),
            success: (message) => logger.log(message, 'success'),
            clear: () => document.getElementById('console-log').innerHTML = ''
        };

        async function testScopusConnection() {
            logger.clear();
            logger.log('🔬 Testing direct Scopus API connection...');
            logger.log('🔑 API Key: ' + SCOPUS_API_KEY);
            logger.log('🌐 Base URL: ' + SCOPUS_BASE_URL);
            
            // Simple test query - search for any IIT Hyderabad publications
            const testQuery = 'AFFILORG(60103917) AND PUBYEAR = 2024';
            const encodedQuery = encodeURIComponent(testQuery);
            const url = `${SCOPUS_BASE_URL}/search/scopus?query=${encodedQuery}&count=1`;
            
            logger.log('🎯 Test URL: ' + url);
            
            try {
                logger.log('📡 Making fetch request...');
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'X-ELS-APIKey': SCOPUS_API_KEY,
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    mode: 'cors'
                });
                
                logger.log('📊 Response status: ' + response.status);
                logger.log('📋 Response headers: ' + JSON.stringify(Object.fromEntries(response.headers.entries()), null, 2));
                
                if (!response.ok) {
                    const errorText = await response.text();
                    logger.error('❌ API Error Response: ' + errorText);
                    throw new Error(`Scopus API Error ${response.status}: ${errorText}`);
                }
                
                const data = await response.json();
                logger.success('✅ Success! Connection established');
                logger.success('📈 Total results found: ' + data['search-results']['opensearch:totalResults']);
                if (data['search-results']['entry']?.[0]?.[`dc:title`]) {
                    logger.success('📄 First result title: ' + data['search-results']['entry'][0][`dc:title`]);
                }
                
                return data;
                
            } catch (error) {
                logger.error('💥 Error Details:');
                logger.error('🏷️  Error type: ' + error.constructor.name);
                logger.error('💬 Error message: ' + error.message);
                logger.error('🔍 Full error: ' + JSON.stringify(error, Object.getOwnPropertyNames(error), 2));
                
                // Check for specific error types
                if (error.message.includes('CORS')) {
                    logger.error('🔴 CORS Error: Browser is blocking cross-origin request');
                    logger.error('🔍 This means the campus IP subscription may not bypass browser CORS restrictions');
                    logger.error('💡 Possible solutions:');
                    logger.error('   - Use a CORS proxy');
                    logger.error('   - Configure server-side proxy');
                    logger.error('   - Use Scopus API from backend instead of frontend');
                } else if (error.message.includes('Failed to fetch')) {
                    logger.error('🔴 Network Error: Cannot reach Scopus API');
                    logger.error('🔍 This could be due to network connectivity or firewall restrictions');
                    logger.error('💡 Possible solutions:');
                    logger.error('   - Check internet connection');
                    logger.error('   - Verify campus network allows Scopus API access');
                    logger.error('   - Contact IT support about firewall settings');
                } else if (error.message.includes('401')) {
                    logger.error('🔴 Authentication Error: API key invalid or expired');
                    logger.error('💡 Contact Scopus support or request new API key');
                } else if (error.message.includes('403')) {
                    logger.error('🔴 Authorization Error: API key valid but insufficient permissions');
                    logger.error('💡 Contact Scopus support to verify API key permissions');
                }
                
                throw error;
            }
        }

        async function runTest() {
            const outputDiv = document.getElementById('output');
            outputDiv.style.display = 'block';
            
            try {
                await testScopusConnection();
                logger.success('🎉 API connection test completed successfully!');
            } catch (error) {
                logger.error('❌ API connection test failed');
                logger.error('🚨 Please share these error details for further diagnosis');
            }
        }
    </script>
</body>
</html>
